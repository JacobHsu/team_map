name: Daily Screenshot

on:
  schedule:
    # Run daily at 23:00 UTC (07:00 Taiwan time next day)
    # Only during NBA season: Oct-Jun
    - cron: '0 23 * 1-6,10-12 *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  screenshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Take screenshot
        env:
          SCREENSHOTONE_ACCESS_KEY: ${{ secrets.SCREENSHOTONE_ACCESS_KEY }}
        run: python screenshot.py

      - name: Generate upsets data
        id: upsets
        run: python NBA/scrape_odds.py

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add screenshots/ upsets/
          
          # Use Python to get Taiwan timezone date (UTC+8)
          TAIWAN_DATE=$(python -c "from datetime import datetime, timezone, timedelta; print(datetime.now(timezone(timedelta(hours=8))).strftime('%Y-%m-%d'))")
          TAIWAN_DAY=$(python -c "from datetime import datetime, timezone, timedelta; print(datetime.now(timezone(timedelta(hours=8))).strftime('%d'))")
          
          # Build commit message with underdog teams if any
          COMMIT_MSG="chore: update oddsportal screenshot $TAIWAN_DATE"
          
          # Check if there are upsets and add to commit message
          if [ -f "upsets/upsets_${TAIWAN_DAY}.json" ]; then
            UPSET_COUNT=$(python -c "import json; data=json.load(open('upsets/upsets_${TAIWAN_DAY}.json')); print(data.get('upset_count', 0))")
            if [ "$UPSET_COUNT" -gt 0 ]; then
              UNDERDOGS=$(python -c "import json; data=json.load(open('upsets/upsets_${TAIWAN_DAY}.json')); print(','.join([u['winner_tricode'] for u in data.get('upsets', [])]))")
              COMMIT_MSG="$COMMIT_MSG - $UNDERDOGS ($UPSET_COUNT)"
            fi
          fi
          
          git diff --staged --quiet || git commit -m "$COMMIT_MSG"
          git push
