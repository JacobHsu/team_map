<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA 球隊位置互動儀表板</title>
    <link rel="icon" type="image/png" href="https://www.nba.com/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Sportradar Widget Loader -->
    <script type="application/javascript" src="https://widgets.media.sportradar.com/uscommon/widgetloader" data-sr-language="en_us" async></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            /* 更新: 使用 Roboto 作為全局字體 */
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            overflow: hidden;
        }
        .dashboard-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 15px;
            box-sizing: border-box;
        }
        h1 {
            color: #1a237e;
            text-align: center;
            margin: 0 0 15px 0;
            flex-shrink: 0;
            font-weight: 700;
        }
        .main-content {
            display: flex;
            flex-grow: 1;
            gap: 15px;
            overflow: hidden;
        }
        .legend-sidebar {
            flex: 1;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 15px 20px;
            overflow-y: auto;
        }
        #map-container {
            flex: 2.5;
            display: flex;
        }
        #map {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .league-column h3 {
            color: #c9082a; /* NBA Red */
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
            margin-top: 0;
            position: sticky;
            top: -15px;
            background-color: #ffffff;
            z-index: 10;
        }
        .division-block h4 {
            color: #17408b; /* NBA Blue */
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            padding: 7px 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .legend-item:hover {
            background-color: #e3f2fd;
        }
        .legend-item img {
            width: 28px; /* 微調圖示大小 */
            height: 28px;
            margin-right: 12px;
            object-fit: contain;
            flex-shrink: 0;
        }
        .team-name-container {
            line-height: 1.45;
            pointer-events: none;
        }
        .team-name-container .name-zh {
            font-size: 14px;
            font-weight: 700; /* 使用 Bold 字重 */
            color: #000;
        }
        .legend-item .polymarket-logo {
            width: 32px;
            height: 32px;
            margin-left: auto;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .spread-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 4px;
            font-family: 'Roboto', monospace;
            vertical-align: middle;
        }
        .spread-badge.favorite {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .spread-badge.underdog {
            background-color: #fbe9e7;
            color: #c62828;
        }
        .spread-badge.final {
            background-color: #eeeeee;
            color: #616161;
        }
        @keyframes live-pulse {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(0, 0, 0, 0.04); }
        }
        .legend-item.live {
            animation: live-pulse 1s ease-in-out infinite;
        }
        .legend-item .polymarket-logo.winner-expected {
            filter: drop-shadow(0 0 4px rgba(255, 193, 7, 0.8));
        }
        .legend-item .polymarket-logo.winner-upset {
            filter: drop-shadow(0 0 8px rgba(255, 193, 7, 0.9));
        }
        /* -- 更新: 優化英文和縮寫的樣式 -- */
        .team-name-container .name-en-abbr {
            font-size: 13px;  /* 放大字體 */
            color: #555;      /* 使用清晰的深灰色 */
        }
        .standing-rank {
            font-size: 11px;
            font-weight: 700;
            color: #17408b;
            margin-left: 4px;
        }
        .leaflet-control-reset {
            background-color: white;
            width: 34px;
            height: 34px;
            border-radius: 4px;
            border: 2px solid rgba(0,0,0,0.2);
            background-clip: padding-box;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .leaflet-control-reset:hover {
            background-color: #f4f4f4;
        }
        .leaflet-control-reset svg {
            width: 20px;
            height: 20px;
            fill: #333;
        }
        .leaflet-control-odds {
            background-color: white;
            width: 34px;
            height: 34px;
            border-radius: 4px;
            border: 2px solid rgba(0,0,0,0.2);
            background-clip: padding-box;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .leaflet-control-odds:hover {
            background-color: #f4f4f4;
        }
        .leaflet-control-odds svg {
            width: 20px;
            height: 20px;
            fill: #333;
        }
        .leaflet-tooltip.custom-tooltip {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #999;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 10px;
            line-height: 1.5;
        }
        .tooltip-location {
            font-size: 15px;
            font-weight: 700;
            color: #000;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
            margin-bottom: 4px;
        }
        .tooltip-details {
            color: #333;
            font-size: 14px;
        }
        .tooltip-details .name-en {
            color: #555;
            font-size: 13px;
        }

        /* Sportradar Score Ticker Styles */
        .score-ticker-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            padding: 10px;
            flex-shrink: 0;
        }

        .sr-widget {
            width: 100%;
            min-height: 60px;
        }

        /* Hide Sportradar widget when not on localhost */
        .score-ticker-container.hidden {
            display: none;
        }

        /* Fallback message for non-localhost environments */
        .ticker-fallback {
            display: none;
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .ticker-fallback.show {
            display: block;
        }

        /* ESPN Custom Score Ticker Styles - Sportradar Style */
        .espn-ticker-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            flex-shrink: 0;
            overflow: hidden;
            display: none;
            position: relative;
        }
        .espn-ticker-container.show {
            display: block;
        }
        .espn-ticker-scroll {
            display: flex;
            align-items: center;
            overflow-x: auto;
            scrollbar-width: none;
            padding: 8px 0;
        }
        .espn-ticker-scroll::-webkit-scrollbar {
            display: none;
        }
        /* Date navigation - inline with games */
        .ticker-date-nav {
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-right: 1px solid #e0e0e0;
            flex-shrink: 0;
            gap: 6px;
        }
        .ticker-date-nav button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            color: #666;
            transition: color 0.15s;
        }
        .ticker-date-nav button:hover {
            color: #333;
        }
        .ticker-date-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
        }
        .ticker-date-text .day {
            font-size: 11px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
        }
        .ticker-date-text .date {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        .ticker-game {
            display: flex;
            align-items: center;
            padding: 4px 12px;
            border-right: 1px solid #e0e0e0;
            flex-shrink: 0;
            cursor: pointer;
            transition: background-color 0.15s;
            gap: 2px;
        }
        .ticker-game:hover {
            background-color: #f5f5f5;
        }
        .ticker-game:last-child {
            border-right: none;
        }
        .ticker-game.live {
            background-color: #fef7f7;
        }
        /* Team display: Logo on top, Abbr below */
        .ticker-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 32px;
        }
        .ticker-team img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        .ticker-team .abbr {
            font-size: 10px;
            font-weight: 700;
            color: #333;
            margin-top: 2px;
        }
        /* Score/Status section in the middle */
        .ticker-middle {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 6px;
            min-width: 55px;
        }
        .ticker-middle .status-line {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 500;
            text-align: center;
        }
        .ticker-middle .status-line.live {
            color: #c9082a;
            font-weight: 700;
        }
        .ticker-middle .score-line {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            text-align: center;
        }
        .ticker-middle .score-line .winner {
            color: #000;
        }
        .ticker-middle .score-line .loser {
            color: #999;
        }
        /* Scheduled game: date (18px bold) + time (12px bold, padding-top 4px) */
        .ticker-middle .date-line {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            text-align: center;
        }
        .ticker-middle .time-line {
            font-size: 12px;
            font-weight: 700;
            color: #666;
            line-height: 14px;
            padding-top: 4px;
            text-align: center;
        }
        .ticker-no-games {
            text-align: center;
            color: #666;
            padding: 15px 20px;
            font-size: 13px;
            flex-shrink: 0;
        }
        /* Scroll arrows for games list */
        .ticker-scroll-arrow {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .ticker-scroll-arrow.show {
            opacity: 1;
            pointer-events: auto;
        }
        .ticker-scroll-arrow.left {
            left: 100px; /* After date nav */
            background: linear-gradient(to right, #fff 60%, transparent);
        }
        .ticker-scroll-arrow.right {
            right: 0;
            background: linear-gradient(to left, #fff 60%, transparent);
        }
        .ticker-scroll-arrow svg {
            width: 20px;
            height: 20px;
            fill: #666;
        }
        .ticker-scroll-arrow:hover svg {
            fill: #333;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <h1>NBA 球隊位置互動儀表板</h1>

        <!-- Sportradar Score Ticker (localhost only) -->
        <div class="score-ticker-container" id="scoreTickerContainer">
            <div class="sr-widget" data-sr-widget="us.common.scoreTicker" data-sr-sport="nba"></div>
        </div>

        <!-- ESPN Custom Score Ticker (cloud/deployed sites) -->
        <div class="espn-ticker-container" id="espnTickerContainer">
            <div class="ticker-scroll-arrow left" id="tickerScrollLeft">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </div>
            <div class="ticker-scroll-arrow right" id="tickerScrollRight">
                <svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
            </div>
            <div class="espn-ticker-scroll" id="espnTickerScroll">
                <div class="ticker-date-nav">
                    <button id="tickerPrevDay">‹</button>
                    <div class="ticker-date-text" id="tickerDateText">
                        <span class="day">MON</span>
                        <span class="date">JAN 26</span>
                    </div>
                    <button id="tickerNextDay">›</button>
                </div>
                <div class="ticker-no-games">載入中...</div>
            </div>
        </div>

        <div class="main-content">
            <div class="legend-sidebar">
                <div class="league-column">
                    <h3>東區聯盟 (Eastern Conference)</h3>
                    <div id="east-atlantic-legend" class="division-block"><h4>大西洋組 (Atlantic)</h4></div>
                    <div id="east-central-legend" class="division-block"><h4>中央組 (Central)</h4></div>
                    <div id="east-southeast-legend" class="division-block"><h4>東南組 (Southeast)</h4></div>
                </div>
            </div>
            <div id="map-container">
                <div id="map"></div>
            </div>
            <div class="legend-sidebar">
                <div class="league-column">
                    <h3>西區聯盟 (Western Conference)</h3>
                    <div id="west-northwest-legend" class="division-block"><h4>西北組 (Northwest)</h4></div>
                    <div id="west-pacific-legend" class="division-block"><h4>太平洋組 (Pacific)</h4></div>
                    <div id="west-southwest-legend" class="division-block"><h4>西南組 (Southwest)</h4></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if running on localhost and manage ticker visibility
        function checkLocalhost() {
            const isLocalhost = window.location.hostname === 'localhost' ||
                                window.location.hostname === '127.0.0.1' ||
                                window.location.hostname === '' ||
                                window.location.protocol === 'file:';

            const sportradarTicker = document.getElementById('scoreTickerContainer');
            const espnTicker = document.getElementById('espnTickerContainer');
            const pageTitle = document.querySelector('h1');

            if (isLocalhost) {
                // Show Sportradar ticker on localhost only, hide ESPN ticker and title
                sportradarTicker.classList.remove('hidden');
                espnTicker.classList.remove('show');
                if (pageTitle) pageTitle.style.display = 'none';
                // Don't call fetchEspnTicker() on localhost
            } else {
                // Hide Sportradar, show ESPN ticker on deployed sites, hide title
                sportradarTicker.classList.add('hidden');
                espnTicker.classList.add('show');
                if (pageTitle) pageTitle.style.display = 'none';
                fetchEspnTicker();
            }
        }

        // ESPN Ticker: day offset from today (-1=yesterday, 0=today, 1=tomorrow)
        let tickerDayOffset = 0;

        // Get date with offset from today in LOCAL timezone, returns YYYYMMDD
        // This ensures the date navigation matches the user's local time
        function getDateWithOffset(offset) {
            // Get current time in local timezone
            const now = new Date();
            const localDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            localDate.setDate(localDate.getDate() + offset);

            return localDate.getFullYear() +
                String(localDate.getMonth() + 1).padStart(2, '0') +
                String(localDate.getDate()).padStart(2, '0');
        }

        // Format YYYYMMDD to display (e.g., "MON JAN 26") - using local timezone
        function formatDateForDisplay(yyyymmdd) {
            const year = parseInt(yyyymmdd.substring(0, 4));
            const month = parseInt(yyyymmdd.substring(4, 6)) - 1;
            const day = parseInt(yyyymmdd.substring(6, 8));
            const date = new Date(year, month, day, 12, 0, 0);
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            return {
                day: days[date.getDay()],
                date: `${months[date.getMonth()]} ${date.getDate()}`
            };
        }

        // Update navigation arrow visibility (hide at boundaries)
        function updateNavArrows() {
            const prevBtn = document.getElementById('tickerPrevDay');
            const nextBtn = document.getElementById('tickerNextDay');
            // Hide left arrow at yesterday (-1), hide right arrow at tomorrow (+1)
            prevBtn.style.visibility = tickerDayOffset <= -1 ? 'hidden' : 'visible';
            nextBtn.style.visibility = tickerDayOffset >= 1 ? 'hidden' : 'visible';
        }

        // Fetch ESPN ticker with a custom display label (for fallback to yesterday while showing today's date)
        function fetchEspnTickerWithLabel(fetchDate, displayLabelDate) {
            const container = document.getElementById('espnTickerScroll');
            const dateTextEl = document.getElementById('tickerDateText');

            console.log('=== ESPN Ticker With Label ===');
            console.log('Fetch date:', fetchDate);
            console.log('Display label date:', displayLabelDate);

            const url = `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard?dates=${fetchDate}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    // Keep date nav, clear games
                    const dateNav = container.querySelector('.ticker-date-nav');
                    container.innerHTML = '';
                    container.appendChild(dateNav);

                    // Use the displayLabelDate for the date label (shows "today" even when fetching yesterday)
                    const formatted = formatDateForDisplay(displayLabelDate);
                    dateTextEl.innerHTML = `
                        <span class="day">${formatted.day}</span>
                        <span class="date">${formatted.date}</span>
                    `;

                    if (!data.events || data.events.length === 0) {
                        container.innerHTML = '';
                        container.appendChild(dateNav);
                        const noGames = document.createElement('div');
                        noGames.className = 'ticker-no-games';
                        noGames.textContent = '無比賽';
                        container.appendChild(noGames);
                        return;
                    }

                    // Render games (reuse the same rendering logic)
                    const tickerAbbrMap = {
                        'NY': 'NYK', 'NO': 'NOP', 'SA': 'SAS',
                        'GS': 'GSW', 'UTAH': 'UTA', 'WSH': 'WAS'
                    };
                    const mapAbbr = (abbr) => tickerAbbrMap[abbr] || abbr;

                    data.events.forEach(event => {
                        const competition = event.competitions[0];
                        const status = event.status.type;
                        // Include halftime, end of period, and other mid-game states as "live"
                        const isLive = status.name === 'STATUS_IN_PROGRESS' ||
                                       status.name === 'STATUS_HALFTIME' ||
                                       status.name === 'STATUS_END_PERIOD';
                        const isFinal = status.name === 'STATUS_FINAL';
                        const isScheduled = status.name === 'STATUS_SCHEDULED';

                        const homeTeam = competition.competitors.find(c => c.homeAway === 'home');
                        const awayTeam = competition.competitors.find(c => c.homeAway === 'away');
                        const awayAbbr = mapAbbr(awayTeam.team.abbreviation);
                        const homeAbbr = mapAbbr(homeTeam.team.abbreviation);

                        const gameCard = document.createElement('div');
                        gameCard.className = 'ticker-game';
                        if (isLive) gameCard.classList.add('live');

                        const awayDiv = document.createElement('div');
                        awayDiv.className = 'ticker-team';
                        awayDiv.innerHTML = `
                            <img src="${awayTeam.team.logo}" alt="${awayAbbr}">
                            <span class="abbr">${awayAbbr}</span>
                        `;

                        const middleDiv = document.createElement('div');
                        middleDiv.className = 'ticker-middle';

                        if (isScheduled) {
                            const gameDate = new Date(event.date);
                            const dateShort = `${gameDate.getMonth() + 1}/${gameDate.getDate()}`;
                            const timeStr = gameDate.toLocaleTimeString('en-US', {
                                hour: 'numeric', minute: '2-digit', hour12: true
                            });
                            middleDiv.innerHTML = `
                                <span class="date-line">${dateShort}</span>
                                <span class="time-line">${timeStr}</span>
                            `;
                        } else if (isLive) {
                            middleDiv.innerHTML = `
                                <span class="status-line live">${status.detail || 'LIVE'}</span>
                                <span class="score-line">${awayTeam.score} - ${homeTeam.score}</span>
                            `;
                        } else {
                            const awayClass = awayTeam.winner ? 'winner' : 'loser';
                            const homeClass = homeTeam.winner ? 'winner' : 'loser';
                            middleDiv.innerHTML = `
                                <span class="status-line">FINAL</span>
                                <span class="score-line"><span class="${awayClass}">${awayTeam.score}</span> - <span class="${homeClass}">${homeTeam.score}</span></span>
                            `;
                        }

                        const homeDiv = document.createElement('div');
                        homeDiv.className = 'ticker-team';
                        homeDiv.innerHTML = `
                            <img src="${homeTeam.team.logo}" alt="${homeAbbr}">
                            <span class="abbr">${homeAbbr}</span>
                        `;

                        gameCard.appendChild(awayDiv);
                        gameCard.appendChild(middleDiv);
                        gameCard.appendChild(homeDiv);
                        container.appendChild(gameCard);
                    });

                    setTimeout(updateScrollArrows, 100);
                })
                .catch(err => {
                    console.warn('Failed to fetch ESPN ticker with label:', err);
                });
        }

        // Fetch and render ESPN score ticker (Sportradar style)
        // Uses cross-day query: fetches both target date and previous date from ESPN API,
        // then merges all games that have UTC dates falling on the target date
        function fetchEspnTicker(forceDate = null) {
            const container = document.getElementById('espnTickerScroll');
            const dateTextEl = document.getElementById('tickerDateText');

            // Get date based on current offset (or use forced date for fallback)
            const requestDate = forceDate || getDateWithOffset(tickerDayOffset);

            // Update navigation arrows
            updateNavArrows();

            // Debug
            console.log('=== ESPN Ticker Debug (Cross-Day) ===');
            console.log('Offset:', tickerDayOffset);
            console.log('Request date:', requestDate);
            console.log('Force date:', forceDate);
            console.log('Local now:', new Date().toString());

            // Calculate previous day for cross-day query
            const prevDate = (() => {
                const d = new Date(requestDate.slice(0, 4), parseInt(requestDate.slice(4, 6)) - 1, parseInt(requestDate.slice(6, 8)));
                d.setDate(d.getDate() - 1);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            })();

            console.log('Previous date for cross-day query:', prevDate);

            // Build URLs for both dates
            const urlCurrent = `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard?dates=${requestDate}`;
            const urlPrev = `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard?dates=${prevDate}`;

            // Fetch both dates in parallel
            Promise.all([
                fetch(urlCurrent).then(res => res.json()),
                fetch(urlPrev).then(res => res.json())
            ])
                .then(([dataCurrent, dataPrev]) => {
                    // Target date for filtering - use LOCAL timezone
                    const targetYear = parseInt(requestDate.slice(0, 4));
                    const targetMonth = parseInt(requestDate.slice(4, 6)) - 1;
                    const targetDay = parseInt(requestDate.slice(6, 8));
                    const targetDateStr = `${requestDate.slice(0, 4)}-${requestDate.slice(4, 6)}-${requestDate.slice(6, 8)}`;
                    console.log('Target LOCAL date for filtering:', targetDateStr);

                    // Merge events from both responses, filtering by LOCAL date
                    const allEvents = [];
                    const seenIds = new Set();

                    // Helper to check if event's LOCAL date matches target
                    const matchesTargetDate = (event) => {
                        // Convert UTC time to local date
                        const gameDate = new Date(event.date);
                        const localYear = gameDate.getFullYear();
                        const localMonth = gameDate.getMonth();
                        const localDay = gameDate.getDate();
                        const matches = localYear === targetYear && localMonth === targetMonth && localDay === targetDay;
                        if (matches) {
                            console.log('Match:', event.shortName, 'UTC:', event.date, 'Local:', gameDate.toLocaleString());
                        }
                        return matches;
                    };

                    // Add events from current date query
                    if (dataCurrent.events) {
                        dataCurrent.events.forEach(event => {
                            if (matchesTargetDate(event) && !seenIds.has(event.id)) {
                                allEvents.push(event);
                                seenIds.add(event.id);
                            }
                        });
                    }

                    // Add events from previous date query (for games that span timezone boundaries)
                    if (dataPrev.events) {
                        dataPrev.events.forEach(event => {
                            if (matchesTargetDate(event) && !seenIds.has(event.id)) {
                                allEvents.push(event);
                                seenIds.add(event.id);
                                console.log('Added from prev day API:', event.shortName, event.date);
                            }
                        });
                    }

                    // Sort by game time
                    allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

                    console.log('Total merged events:', allEvents.length);

                    // Smart date logic (Sportradar style):
                    // If offset=0, no forceDate, and all games are scheduled (none live/final),
                    // fall back to yesterday's games but KEEP today's date label
                    if (tickerDayOffset === 0 && !forceDate && allEvents.length > 0) {
                        const hasLiveOrFinal = allEvents.some(event => {
                            const statusName = event.status.type.name;
                            return statusName === 'STATUS_IN_PROGRESS' || statusName === 'STATUS_FINAL';
                        });
                        if (!hasLiveOrFinal) {
                            console.log('All games scheduled, falling back to yesterday (keeping today label)...');
                            // Pass today's date as the display label, but fetch yesterday's games
                            fetchEspnTickerWithLabel(getDateWithOffset(-1), getDateWithOffset(0));
                            return;
                        }
                    }

                    // Keep date nav, clear games
                    const dateNav = container.querySelector('.ticker-date-nav');
                    container.innerHTML = '';
                    container.appendChild(dateNav);

                    // Update date display
                    // Use displayLabel if provided (for fallback cases), otherwise use requestDate
                    const displayDate = forceDate ? getDateWithOffset(tickerDayOffset) : requestDate;
                    const formatted = formatDateForDisplay(displayDate);
                    console.log('Display date:', displayDate, 'Day:', formatted.day);
                    dateTextEl.innerHTML = `
                        <span class="day">${formatted.day}</span>
                        <span class="date">${formatted.date}</span>
                    `;

                    if (allEvents.length === 0) {
                        const noGames = document.createElement('div');
                        noGames.className = 'ticker-no-games';
                        noGames.textContent = '無比賽';
                        container.appendChild(noGames);
                        return;
                    }

                    // Abbreviation mapping (ESPN -> standard)
                    const tickerAbbrMap = {
                        'NY': 'NYK', 'NO': 'NOP', 'SA': 'SAS',
                        'GS': 'GSW', 'UTAH': 'UTA', 'WSH': 'WAS'
                    };
                    const mapAbbr = (abbr) => tickerAbbrMap[abbr] || abbr;

                    allEvents.forEach(event => {
                        const competition = event.competitions[0];
                        const status = event.status.type;
                        // Include halftime, end of period, and other mid-game states as "live"
                        const isLive = status.name === 'STATUS_IN_PROGRESS' ||
                                       status.name === 'STATUS_HALFTIME' ||
                                       status.name === 'STATUS_END_PERIOD';
                        const isFinal = status.name === 'STATUS_FINAL';
                        const isScheduled = status.name === 'STATUS_SCHEDULED';
                        const isPostponed = status.name === 'STATUS_POSTPONED';

                        // Skip postponed games
                        if (isPostponed) {
                            console.log('Skipping postponed game:', event.shortName);
                            return;
                        }

                        // Show all games (scheduled, live, final)

                        // Get teams
                        const homeTeam = competition.competitors.find(c => c.homeAway === 'home');
                        const awayTeam = competition.competitors.find(c => c.homeAway === 'away');

                        // Map abbreviations
                        const awayAbbr = mapAbbr(awayTeam.team.abbreviation);
                        const homeAbbr = mapAbbr(homeTeam.team.abbreviation);

                        // Create game card
                        const gameCard = document.createElement('div');
                        gameCard.className = 'ticker-game';
                        if (isLive) gameCard.classList.add('live');

                        // Away team (left): Logo on top, Abbr below
                        const awayDiv = document.createElement('div');
                        awayDiv.className = 'ticker-team';
                        awayDiv.innerHTML = `
                            <img src="${awayTeam.team.logo}" alt="${awayAbbr}">
                            <span class="abbr">${awayAbbr}</span>
                        `;

                        // Middle section: depends on game status
                        const middleDiv = document.createElement('div');
                        middleDiv.className = 'ticker-middle';

                        if (isScheduled) {
                            // Scheduled: show date and time in LOCAL timezone (like Sportradar)
                            const gameDate = new Date(event.date);
                            const dateShort = `${gameDate.getMonth() + 1}/${gameDate.getDate()}`;
                            const timeStr = gameDate.toLocaleTimeString('en-US', {
                                hour: 'numeric',
                                minute: '2-digit',
                                hour12: true
                            });
                            middleDiv.innerHTML = `
                                <span class="date-line">${dateShort}</span>
                                <span class="time-line">${timeStr}</span>
                            `;
                        } else if (isLive) {
                            // Live: show status (Q3 5:23) on top, score below
                            const awayScore = awayTeam.score;
                            const homeScore = homeTeam.score;
                            middleDiv.innerHTML = `
                                <span class="status-line live">${status.detail || 'LIVE'}</span>
                                <span class="score-line">${awayScore} - ${homeScore}</span>
                            `;
                        } else {
                            // Final: show FINAL on top, score below
                            const awayClass = awayTeam.winner ? 'winner' : 'loser';
                            const homeClass = homeTeam.winner ? 'winner' : 'loser';
                            middleDiv.innerHTML = `
                                <span class="status-line">FINAL</span>
                                <span class="score-line"><span class="${awayClass}">${awayTeam.score}</span> - <span class="${homeClass}">${homeTeam.score}</span></span>
                            `;
                        }

                        // Home team (right): Logo on top, Abbr below
                        const homeDiv = document.createElement('div');
                        homeDiv.className = 'ticker-team';
                        homeDiv.innerHTML = `
                            <img src="${homeTeam.team.logo}" alt="${homeAbbr}">
                            <span class="abbr">${homeAbbr}</span>
                        `;

                        gameCard.appendChild(awayDiv);
                        gameCard.appendChild(middleDiv);
                        gameCard.appendChild(homeDiv);
                        container.appendChild(gameCard);
                    });

                    // Update scroll arrows after content is rendered
                    setTimeout(updateScrollArrows, 100);
                })
                .catch(err => {
                    console.warn('Failed to fetch ESPN ticker:', err);
                    const dateNav = container.querySelector('.ticker-date-nav');
                    container.innerHTML = '';
                    container.appendChild(dateNav);
                    const noGames = document.createElement('div');
                    noGames.className = 'ticker-no-games';
                    noGames.textContent = '無法載入';
                    container.appendChild(noGames);
                    setTimeout(updateScrollArrows, 100);
                });
        }

        // Run when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            checkLocalhost();

            // Date navigation event listeners
            document.getElementById('tickerPrevDay').addEventListener('click', () => {
                if (tickerDayOffset > -1) {
                    tickerDayOffset--;
                    fetchEspnTicker();
                }
            });
            document.getElementById('tickerNextDay').addEventListener('click', () => {
                if (tickerDayOffset < 1) {
                    tickerDayOffset++;
                    fetchEspnTicker();
                }
            });

            // Scroll arrows visibility for games list
            const tickerScroll = document.getElementById('espnTickerScroll');
            tickerScroll.addEventListener('scroll', updateScrollArrows);
            window.addEventListener('resize', updateScrollArrows);

            // Scroll arrow click handlers
            document.getElementById('tickerScrollLeft').addEventListener('click', () => scrollTicker(-1));
            document.getElementById('tickerScrollRight').addEventListener('click', () => scrollTicker(1));

            // Initial arrow state
            setTimeout(updateScrollArrows, 500);
        });

        // Update scroll arrow visibility based on scroll position
        function updateScrollArrows() {
            const container = document.getElementById('espnTickerScroll');
            const leftArrow = document.getElementById('tickerScrollLeft');
            const rightArrow = document.getElementById('tickerScrollRight');

            if (!container || !leftArrow || !rightArrow) return;

            const scrollLeft = container.scrollLeft;
            const scrollWidth = container.scrollWidth;
            const clientWidth = container.clientWidth;
            const dateNavWidth = 100; // Approximate width of date nav

            // Show left arrow if scrolled past the beginning
            if (scrollLeft > 10) {
                leftArrow.classList.add('show');
            } else {
                leftArrow.classList.remove('show');
            }

            // Show right arrow if there's more content to scroll
            if (scrollLeft + clientWidth < scrollWidth - 10) {
                rightArrow.classList.add('show');
            } else {
                rightArrow.classList.remove('show');
            }
        }

        // Scroll the games list
        function scrollTicker(direction) {
            const container = document.getElementById('espnTickerScroll');
            const scrollAmount = 200; // Pixels to scroll
            container.scrollBy({
                left: direction * scrollAmount,
                behavior: 'smooth'
            });
        }

        // Auto-refresh ESPN ticker every 60 seconds when visible
        setInterval(() => {
            const espnTicker = document.getElementById('espnTickerContainer');
            if (espnTicker.classList.contains('show')) {
                // Refresh with current date to stay on same day
                fetchEspnTicker();
            }
        }, 60000);

        const initialCenter = [39.8283, -98.5795];
        const initialZoom = 4;

        const map = L.map('map').setView(initialCenter, initialZoom);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map);

        const teams = [
            // Eastern Conference - Atlantic
            { name: "波士頓塞爾提克", name_en: "Boston Celtics", abbr: "BOS", city: "波士頓", state: "MA", lat: 42.3662, lon: -71.0621, logo: "https://a.espncdn.com/i/teamlogos/nba/500/bos.png", league: "East", division: "Atlantic" },
            { name: "布魯克林籃網", name_en: "Brooklyn Nets", abbr: "BKN", city: "布魯克林", state: "NY", lat: 40.6826, lon: -73.9754, logo: "https://a.espncdn.com/i/teamlogos/nba/500/bkn.png", league: "East", division: "Atlantic" },
            { name: "紐約尼克", name_en: "New York Knicks", abbr: "NYK", city: "紐約", state: "NY", lat: 40.7505, lon: -73.9934, logo: "https://a.espncdn.com/i/teamlogos/nba/500/nyk.png", league: "East", division: "Atlantic" },
            { name: "費城76人", name_en: "Philadelphia 76ers", abbr: "PHI", city: "費城", state: "PA", lat: 39.9012, lon: -75.1720, logo: "https://a.espncdn.com/i/teamlogos/nba/500/phi.png", league: "East", division: "Atlantic" },
            { name: "多倫多暴龍", name_en: "Toronto Raptors", abbr: "TOR", city: "多倫多", state: "ON", lat: 43.6435, lon: -79.3791, logo: "https://a.espncdn.com/i/teamlogos/nba/500/tor.png", league: "East", division: "Atlantic" },

            // Eastern Conference - Central
            { name: "芝加哥公牛", name_en: "Chicago Bulls", abbr: "CHI", city: "芝加哥", state: "IL", lat: 41.8807, lon: -87.6742, logo: "https://a.espncdn.com/i/teamlogos/nba/500/chi.png", league: "East", division: "Central" },
            { name: "克里夫蘭騎士", name_en: "Cleveland Cavaliers", abbr: "CLE", city: "克里夫蘭", state: "OH", lat: 41.4966, lon: -81.6882, logo: "https://a.espncdn.com/i/teamlogos/nba/500/cle.png", league: "East", division: "Central" },
            { name: "底特律活塞", name_en: "Detroit Pistons", abbr: "DET", city: "底特律", state: "MI", lat: 42.3411, lon: -83.0550, logo: "https://a.espncdn.com/i/teamlogos/nba/500/det.png", league: "East", division: "Central" },
            { name: "印第安納溜馬", name_en: "Indiana Pacers", abbr: "IND", city: "印第安納波利斯", state: "IN", lat: 39.7640, lon: -86.1555, logo: "https://a.espncdn.com/i/teamlogos/nba/500/ind.png", league: "East", division: "Central" },
            { name: "密爾瓦基公鹿", name_en: "Milwaukee Bucks", abbr: "MIL", city: "密爾瓦基", state: "WI", lat: 43.0451, lon: -87.9174, logo: "https://a.espncdn.com/i/teamlogos/nba/500/mil.png", league: "East", division: "Central" },

            // Eastern Conference - Southeast
            { name: "亞特蘭大老鷹", name_en: "Atlanta Hawks", abbr: "ATL", city: "亞特蘭大", state: "GA", lat: 33.7573, lon: -84.3963, logo: "https://a.espncdn.com/i/teamlogos/nba/500/atl.png", league: "East", division: "Southeast" },
            { name: "夏洛特黃蜂", name_en: "Charlotte Hornets", abbr: "CHA", city: "夏洛特", state: "NC", lat: 35.2251, lon: -80.8392, logo: "https://a.espncdn.com/i/teamlogos/nba/500/cha.png", league: "East", division: "Southeast" },
            { name: "邁阿密熱火", name_en: "Miami Heat", abbr: "MIA", city: "邁阿密", state: "FL", lat: 25.7814, lon: -80.1870, logo: "https://a.espncdn.com/i/teamlogos/nba/500/mia.png", league: "East", division: "Southeast" },
            { name: "奧蘭多魔術", name_en: "Orlando Magic", abbr: "ORL", city: "奧蘭多", state: "FL", lat: 28.5392, lon: -81.3839, logo: "https://a.espncdn.com/i/teamlogos/nba/500/orl.png", league: "East", division: "Southeast" },
            { name: "華盛頓巫師", name_en: "Washington Wizards", abbr: "WAS", city: "華盛頓特區", state: "DC", lat: 38.8982, lon: -77.0209, logo: "https://a.espncdn.com/i/teamlogos/nba/500/was.png", league: "East", division: "Southeast" },

            // Western Conference - Northwest
            { name: "丹佛金塊", name_en: "Denver Nuggets", abbr: "DEN", city: "丹佛", state: "CO", lat: 39.7487, lon: -105.0076, logo: "https://a.espncdn.com/i/teamlogos/nba/500/den.png", league: "West", division: "Northwest" },
            { name: "明尼蘇達灰狼", name_en: "Minnesota Timberwolves", abbr: "MIN", city: "明尼亞波利斯", state: "MN", lat: 44.9795, lon: -93.2761, logo: "https://a.espncdn.com/i/teamlogos/nba/500/min.png", league: "West", division: "Northwest" },
            { name: "奧克拉荷馬雷霆", name_en: "Oklahoma City Thunder", abbr: "OKC", city: "奧克拉荷馬市", state: "OK", lat: 35.4634, lon: -97.5151, logo: "https://a.espncdn.com/i/teamlogos/nba/500/okc.png", league: "West", division: "Northwest" },
            { name: "波特蘭拓荒者", name_en: "Portland Trail Blazers", abbr: "POR", city: "波特蘭", state: "OR", lat: 45.5316, lon: -122.6668, logo: "https://a.espncdn.com/i/teamlogos/nba/500/por.png", league: "West", division: "Northwest" },
            { name: "猶他爵士", name_en: "Utah Jazz", abbr: "UTA", city: "鹽湖城", state: "UT", lat: 40.7683, lon: -111.9011, logo: "https://a.espncdn.com/i/teamlogos/nba/500/utah.png", league: "West", division: "Northwest" },

            // Western Conference - Pacific
            { name: "金州勇士", name_en: "Golden State Warriors", abbr: "GSW", city: "舊金山", state: "CA", lat: 37.7680, lon: -122.3877, logo: "https://a.espncdn.com/i/teamlogos/nba/500/gsw.png", league: "West", division: "Pacific" },
            { name: "洛杉磯快艇", name_en: "LA Clippers", abbr: "LAC", city: "洛杉磯", state: "CA", lat: 34.0430, lon: -118.2673, logo: "https://a.espncdn.com/i/teamlogos/nba/500/lac.png", league: "West", division: "Pacific" },
            { name: "洛杉磯湖人", name_en: "Los Angeles Lakers", abbr: "LAL", city: "洛杉磯", state: "CA", lat: 34.0430, lon: -118.2673, logo: "https://a.espncdn.com/i/teamlogos/nba/500/lal.png", league: "West", division: "Pacific" },
            { name: "鳳凰城太陽", name_en: "Phoenix Suns", abbr: "PHX", city: "鳳凰城", state: "AZ", lat: 33.4457, lon: -112.0712, logo: "https://a.espncdn.com/i/teamlogos/nba/500/phx.png", league: "West", division: "Pacific" },
            { name: "沙加緬度國王", name_en: "Sacramento Kings", abbr: "SAC", city: "沙加緬度", state: "CA", lat: 38.5802, lon: -121.4997, logo: "https://a.espncdn.com/i/teamlogos/nba/500/sac.png", league: "West", division: "Pacific" },

            // Western Conference - Southwest
            { name: "達拉斯獨行俠", name_en: "Dallas Mavericks", abbr: "DAL", city: "達拉斯", state: "TX", lat: 32.7905, lon: -96.8103, logo: "https://a.espncdn.com/i/teamlogos/nba/500/dal.png", league: "West", division: "Southwest" },
            { name: "休士頓火箭", name_en: "Houston Rockets", abbr: "HOU", city: "休士頓", state: "TX", lat: 29.7508, lon: -95.3621, logo: "https://a.espncdn.com/i/teamlogos/nba/500/hou.png", league: "West", division: "Southwest" },
            { name: "曼菲斯灰熊", name_en: "Memphis Grizzlies", abbr: "MEM", city: "曼菲斯", state: "TN", lat: 35.1381, lon: -90.0506, logo: "https://a.espncdn.com/i/teamlogos/nba/500/mem.png", league: "West", division: "Southwest" },
            { name: "紐奧良鵜鶘", name_en: "New Orleans Pelicans", abbr: "NOP", city: "紐奧良", state: "LA", lat: 29.9490, lon: -90.0821, logo: "https://a.espncdn.com/i/teamlogos/nba/500/no.png", league: "West", division: "Southwest" },
            { name: "聖安東尼奧馬刺", name_en: "San Antonio Spurs", abbr: "SAS", city: "聖安東尼奧", state: "TX", lat: 29.4270, lon: -98.4375, logo: "https://a.espncdn.com/i/teamlogos/nba/500/sas.png", league: "West", division: "Southwest" }
        ];

        const markers = {};
        let activeMarker = null;

        L.Control.ResetView = L.Control.extend({
            onAdd: function(map) {
                const btn = L.DomUtil.create('div', 'leaflet-control-reset leaflet-bar');
                btn.title = '恢復預設視圖';
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/><path d="M0 0h24v24H0z" fill="none"/></svg>';
                L.DomEvent.on(btn, 'click', function (e) {
                    L.DomEvent.stop(e);
                    map.flyTo(initialCenter, initialZoom);
                    if (activeMarker) {
                        activeMarker.closeTooltip();
                        activeMarker = null;
                    }
                });
                return btn;
            },
            onRemove: function(map) { }
        });
        L.control.resetView = (opts) => new L.Control.ResetView(opts);
        L.control.resetView({ position: 'topleft' }).addTo(map);

        L.Control.OddsLink = L.Control.extend({
            onAdd: function(map) {
                const btn = L.DomUtil.create('div', 'leaflet-control-odds leaflet-bar');
                btn.title = '賠率截圖';
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 2h2v4h-2V5zm-4 8h2v6H8v-6zm8-2h2v8h-2v-8zm-4 4h2v4h-2v-4zM8 7h2v4H8V7z"/></svg>';
                L.DomEvent.on(btn, 'click', function (e) {
                    L.DomEvent.stop(e);
                    window.open('https://www.oddsportal.com/basketball/usa/nba/', '_blank');
                    // window.location.href = 'odds';
                });
                return btn;
            },
            onRemove: function(map) { }
        });
        L.control.oddsLink = (opts) => new L.Control.OddsLink(opts);
        L.control.oddsLink({ position: 'topright' }).addTo(map);

        teams.forEach(team => {
            const teamIcon = L.icon({
                iconUrl: team.logo,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });
            const marker = L.marker([team.lat, team.lon], { icon: teamIcon }).addTo(map);
            const tooltipContent = `
                <div class="tooltip-location">${team.city}, ${team.state}</div>
                <div class="tooltip-details">
                    ${team.name} (${team.abbr})<br>
                    <span class="name-en">${team.name_en}</span>
                </div>
            `;
            marker.bindTooltip(tooltipContent, {
                permanent: false,
                direction: 'top',
                offset: [0, -20],
                className: 'custom-tooltip'
            });
            markers[team.abbr] = marker;

            const targetDivId = `${team.league.toLowerCase()}-${team.division.toLowerCase()}-legend`;
            const legendContainer = document.getElementById(targetDivId);
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.dataset.teamAbbr = team.abbr;
            legendItem.innerHTML = `
                <img src="${team.logo}" alt="${team.name}">
                <div class="team-name-container">
                    <div class="name-zh">${team.name} <span class="spread-badge" id="spread-${team.abbr}" style="display:none;"></span></div>
                    <div class="name-en-abbr">${team.name_en} (${team.abbr}) <span class="standing-rank" id="rank-${team.abbr}"></span></div>
                </div>
                <img class="polymarket-logo" src="https://polymarket.com/_next/image?url=https%3A%2F%2Fpolymarket-upload.s3.us-east-2.amazonaws.com%2FNBA%2BTeam%2BLogos%2F${team.abbr}.png&w=96&q=75" alt="${team.abbr}" onerror="this.style.display='none'">
            `;

            legendItem.addEventListener('click', function() {
                const teamAbbr = this.dataset.teamAbbr;
                const targetMarker = markers[teamAbbr];
                if (targetMarker) {
                    if (activeMarker && activeMarker !== targetMarker) {
                        activeMarker.closeTooltip();
                    }
                    map.flyTo(targetMarker.getLatLng(), 8);
                    map.once('moveend', () => {
                        targetMarker.openTooltip();
                        activeMarker = targetMarker;
                    });
                }
            });

            if (legendContainer) {
                legendContainer.appendChild(legendItem);
            }
        });

        // ESPN abbreviation mapping (ESPN uses different abbrs for some teams)
        const espnAbbrMap = {
            'NY': 'NYK',
            'NO': 'NOP',
            'SA': 'SAS',
            'GS': 'GSW',
            'UTAH': 'UTA',
            'WSH': 'WAS'
        };

        function applyTodaySpread(abbr, spreadLine, isLive) {
            const badge = document.getElementById(`spread-${abbr}`);
            if (badge) {
                badge.textContent = (spreadLine > 0 ? '+' : '') + spreadLine;
                badge.className = 'spread-badge';
                badge.classList.add(spreadLine < 0 ? 'favorite' : 'underdog');
                badge.style.display = 'inline-block';
            }
            const legendItem = document.querySelector(`.legend-item[data-team-abbr="${abbr}"]`);
            if (legendItem) {
                const logo = legendItem.querySelector('.polymarket-logo');
                if (logo) {
                    logo.classList.remove('winner-expected', 'winner-upset');
                }
                if (isLive) {
                    legendItem.classList.add('live');
                }
            }
        }

        function processToday(data) {
            if (!data.events) return;
            const liveGamePromises = [];

            data.events.forEach(event => {
                const competition = event.competitions[0];
                const isLive = event.status.type.name === 'STATUS_IN_PROGRESS';

                if (competition.odds && competition.odds[0]) {
                    // Scheduled games: odds available in scoreboard
                    const odds = competition.odds[0];
                    competition.competitors.forEach(competitor => {
                        let abbr = competitor.team.abbreviation;
                        abbr = espnAbbrMap[abbr] || abbr;
                        const isHome = competitor.homeAway === 'home';
                        let spreadLine = null;
                        if (odds.pointSpread) {
                            const teamOdds = isHome ? odds.pointSpread.home : odds.pointSpread.away;
                            if (teamOdds && teamOdds.close) {
                                spreadLine = parseFloat(teamOdds.close.line);
                            }
                        }
                        if (spreadLine !== null) {
                            applyTodaySpread(abbr, spreadLine, isLive);
                        }
                    });
                } else if (isLive) {
                    // In-progress games: fetch summary for pickcenter odds
                    const promise = fetch(`https://site.web.api.espn.com/apis/site/v2/sports/basketball/nba/summary?event=${event.id}`)
                        .then(res => res.json())
                        .then(summary => {
                            if (!summary.pickcenter || !summary.pickcenter[0]) return;
                            const pickcenter = summary.pickcenter[0];
                            const competitors = summary.header.competitions[0].competitors;
                            competitors.forEach(competitor => {
                                let abbr = competitor.team.abbreviation;
                                abbr = espnAbbrMap[abbr] || abbr;
                                const isHome = competitor.homeAway === 'home';
                                let spreadLine = null;
                                if (pickcenter.pointSpread) {
                                    const teamOdds = isHome ? pickcenter.pointSpread.home : pickcenter.pointSpread.away;
                                    if (teamOdds && teamOdds.close) {
                                        spreadLine = parseFloat(teamOdds.close.line);
                                    }
                                }
                                if (spreadLine !== null) {
                                    applyTodaySpread(abbr, spreadLine, true);
                                }
                            });
                        });
                    liveGamePromises.push(promise);
                }
            });

            return Promise.all(liveGamePromises);
        }

        function processFinishedGame(summaryData, winnersMap) {
            if (!summaryData.pickcenter || !summaryData.pickcenter[0]) return;
            if (!summaryData.header || !summaryData.header.competitions) return;

            const pickcenter = summaryData.pickcenter[0];
            const competitors = summaryData.header.competitions[0].competitors;

            competitors.forEach(competitor => {
                let abbr = competitor.team.abbreviation;
                abbr = espnAbbrMap[abbr] || abbr;
                const isHome = competitor.homeAway === 'home';

                let spreadLine = null;
                if (pickcenter.pointSpread) {
                    const teamOdds = isHome ? pickcenter.pointSpread.home : pickcenter.pointSpread.away;
                    if (teamOdds && teamOdds.close) {
                        spreadLine = parseFloat(teamOdds.close.line);
                    }
                }

                if (spreadLine !== null) {
                    const badge = document.getElementById(`spread-${abbr}`);
                    if (badge) {
                        badge.textContent = (spreadLine > 0 ? '+' : '') + spreadLine;
                        badge.className = 'spread-badge final';
                        badge.style.display = 'inline-block';
                    }

                    if (winnersMap[abbr]) {
                        const isUpset = spreadLine > 0; // underdog won
                        const legendItem = document.querySelector(`.legend-item[data-team-abbr="${abbr}"]`);
                        if (legendItem) {
                            const logo = legendItem.querySelector('.polymarket-logo');
                            if (logo) logo.classList.add(isUpset ? 'winner-upset' : 'winner-expected');
                        }
                    }
                }
            });
        }

        function fetchSpreads() {
            // Calculate yesterday in US Eastern Time (UTC-5)
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const etNow = new Date(utc + (-5 * 3600000));
            const etYesterday = new Date(etNow);
            etYesterday.setDate(etYesterday.getDate() - 1);
            const yStr = etYesterday.getFullYear() +
                String(etYesterday.getMonth() + 1).padStart(2, '0') +
                String(etYesterday.getDate()).padStart(2, '0');

            // Fetch yesterday's scoreboard, then fetch summary for each finished game
            fetch(`https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard?dates=${yStr}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.events) return;
                    const finishedGames = data.events.filter(e => e.status.type.name === 'STATUS_FINAL');

                    const summaryPromises = finishedGames.map(event => {
                        const winnersMap = {};
                        event.competitions[0].competitors.forEach(c => {
                            let abbr = c.team.abbreviation;
                            abbr = espnAbbrMap[abbr] || abbr;
                            if (c.winner) winnersMap[abbr] = true;
                        });

                        return fetch(`https://site.web.api.espn.com/apis/site/v2/sports/basketball/nba/summary?event=${event.id}`)
                            .then(res => res.json())
                            .then(summary => processFinishedGame(summary, winnersMap));
                    });

                    return Promise.all(summaryPromises);
                })
                .then(() => fetch('https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard'))
                .then(res => res.json())
                .then(data => processToday(data))
                .catch(err => console.warn('Failed to fetch spreads:', err));
        }

        fetchSpreads();

        // Fetch conference standings from ESPN API
        function fetchStandings() {
            fetch('https://site.web.api.espn.com/apis/v2/sports/basketball/nba/standings?season=2025')
                .then(res => res.json())
                .then(data => {
                    if (!data.children) return;

                    data.children.forEach(conference => {
                        if (!conference.standings || !conference.standings.entries) return;

                        conference.standings.entries.forEach(entry => {
                            if (!entry.team) return;
                            let abbr = entry.team.abbreviation;
                            abbr = espnAbbrMap[abbr] || abbr;

                            // Get conference rank from stats
                            const rankStat = entry.stats.find(s => s.name === 'playoffSeed');
                            const rank = rankStat ? rankStat.value : null;

                            if (rank !== null) {
                                const rankSpan = document.getElementById(`rank-${abbr}`);
                                if (rankSpan) {
                                    rankSpan.textContent = `#${Math.floor(rank)}`;
                                }
                            }
                        });
                    });
                })
                .catch(err => console.warn('Failed to fetch standings:', err));
        }

        fetchStandings();
    </script>

</body>
</html>
